<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToyFinder - Discover &amp; Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4A49B8'
                    },
                    screens: {
                        'xs': '475px',
                        'portrait': { 'raw': '(orientation: portrait)' },
                        'landscape': { 'raw': '(orientation: landscape)' },
                        'mobile-landscape': { 'raw': '(orientation: landscape) and (max-height: 500px)' }
                    }
                }
            }
        }
    </script>
    <style>
        /* Vintage Map-style effects */
        @keyframes subtleFade {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        @keyframes paperTexture {
            0% { filter: sepia(0.1); }
            100% { filter: sepia(0.3); }
        }
        
        .vintage-fade { animation: subtleFade 4s ease-in-out infinite; }
        
        .vintage-header {
            background: linear-gradient(135deg, #4a3c2a 0%, #3d2f1f 50%, #2d1f13 100%);
            border-bottom: 2px solid #6b5b47;
        }
        
        .vintage-shadow {
            box-shadow: 0 4px 12px rgba(45, 31, 19, 0.3), 0 2px 6px rgba(45, 31, 19, 0.2);
        }
        
        .vintage-border {
            border: 2px solid #8b7355;
            border-radius: 4px;
        }
        
        .vintage-button {
            background: linear-gradient(145deg, #8b7355, #6b5b47);
            border: 1px solid #a68b5b;
            border-radius: 4px;
            transition: all 0.3s ease;
            color: #f4f0e8;
        }
        
        .vintage-button:hover {
            background: linear-gradient(145deg, #9b8365, #7b6b57);
            box-shadow: 0 2px 8px rgba(45, 31, 19, 0.4);
        }
        
        .vintage-panel {
            background: linear-gradient(145deg, #f4f0e8 0%, #e8e0d0 100%);
            border: 2px solid #8b7355;
            border-radius: 6px 6px 0 0;
        }
        
        .vintage-card {
            background: linear-gradient(145deg, #f9f6f0, #f0ebe0);
            border: 1px solid #d4c4a8;
            border-radius: 4px;
        }
        
        .vintage-text-primary {
            color: #5a4a3a;
        }
        
        .vintage-text-secondary {
            color: #8b7355;
        }
        
        .vintage-text-muted {
            color: #a68b5b;
        }
        
        .vintage-search {
            background: #faf8f3;
            border: 2px solid #d4c4a8;
            border-radius: 4px;
            color: #5a4a3a;
        }
        
        .vintage-search:focus {
            border-color: #8b7355;
            box-shadow: 0 0 0 2px rgba(139, 115, 85, 0.2);
        }
        
        .vintage-overlay {
            background: linear-gradient(145deg, #f4f0e8, #e8e0d0);
            border: 2px solid #8b7355;
            border-radius: 6px;
        }
        
        .vintage-legend {
            background: linear-gradient(145deg, #f9f6f0, #f0ebe0);
            border: 2px solid #8b7355;
            border-radius: 6px;
        }
        
        .vintage-tab-active {
            background: linear-gradient(145deg, #8b7355, #6b5b47);
            color: #f4f0e8;
        }
        
        .vintage-tab-inactive {
            background: linear-gradient(145deg, #d4c4a8, #c4b498);
            color: #5a4a3a;
        }
        
        .vintage-tab-inactive:hover {
            background: linear-gradient(145deg, #baa488, #aa9478);
        }
        
        /* Orientation-specific styles */
        @media (orientation: landscape) and (max-height: 500px) {
            .mobile-landscape-adjust {
                height: 70vh !important;
                max-height: 70vh !important;
            }
            .mobile-landscape-header {
                padding-top: 0.25rem !important;
                padding-bottom: 0.25rem !important;
            }
            .mobile-landscape-search {
                top: 3rem !important;
            }
            .mobile-landscape-legend-adaptive {
                bottom: 8px !important;
                left: 4px !important;
                padding: 6px !important;
                max-width: 120px !important;
            }
        }
        
        /* Comprehensive orientation adaptations */
        @media (orientation: landscape) and (min-width: 768px) and (max-height: 600px) {
            /* Tablet landscape */
            .mobile-landscape-legend-adaptive {
                bottom: 12px !important;
                left: 8px !important;
                padding: 8px !important;
                max-width: 160px !important;
            }
        }
        
        @media (orientation: landscape) and (min-width: 1024px) {
            /* Desktop/laptop landscape */
            .mobile-landscape-legend-adaptive {
                bottom: 16px !important;
                left: 16px !important;
                padding: 12px !important;
                max-width: 200px !important;
            }
        }
        
        @media (orientation: portrait) and (max-width: 768px) {
            /* Mobile/tablet portrait - optimize for narrow screens */
            .mobile-landscape-legend-adaptive {
                bottom: 20px !important;
                left: 8px !important;
                max-width: 140px !important;
            }
        }
        
        @media (orientation: portrait) and (min-width: 768px) {
            /* Large tablet/desktop portrait */
            .mobile-landscape-legend-adaptive {
                bottom: 24px !important;
                left: 24px !important;
                max-width: 220px !important;
            }
        }
        
        /* Screen resolution specific adaptations */
        @media (max-width: 320px) {
            .mobile-landscape-legend-adaptive {
                bottom: 12px !important;
                left: 2px !important;
                padding: 4px !important;
                max-width: 100px !important;
            }
        }
        
        @media (min-width: 1920px) {
            .mobile-landscape-legend-adaptive {
                bottom: 32px !important;
                left: 32px !important;
                padding: 20px !important;
                max-width: none !important;
            }
        }
        
        @media (min-width: 2560px) {
            .mobile-landscape-legend-adaptive {
                bottom: 48px !important;
                left: 48px !important;
                padding: 24px !important;
                transform: scale(1.2) !important;
                transform-origin: bottom left !important;
            }
        }
        
        /* High DPI screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .mobile-landscape-legend-adaptive {
                border: 1px solid rgba(0, 0, 0, 0.1);
            }
        }
        
        /* Google Maps Style Category Pills */
        .category-pill {
            @apply flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-full whitespace-nowrap transition-all duration-200 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-300 dark:hover:border-gray-500;
        }
        
        .category-pill.active {
            @apply bg-primary text-white border-primary hover:bg-primary-dark;
        }
        
        .category-pill:focus {
            @apply outline-none ring-2 ring-primary ring-opacity-50;
        }
        
        /* Scrollbar hiding for category pills */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        @media (orientation: portrait) {
            .portrait-panel-height {
                max-height: 60vh;
            }
        }
        
        @media (orientation: landscape) {
            .landscape-panel-height {
                max-height: 50vh;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script async="" defer="" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbHEhUV2VE75urk9wWfHoohDdQCb31EW4&amp;libraries=places&amp;callback=initMap"></script>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.bd4eeeb8e8e02052ee92.js"></script></head>
<body class="bg-white dark:bg-gray-900 transition-colors duration-300">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- Full Screen Map -->
    <div id="map" class="w-full h-screen"></div>
    
    <!-- Map Loading Overlay -->
    <div id="mapLoading" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 z-50">
        <div class="text-center vintage-card vintage-shadow p-8">
            <i class="fas fa-compass fa-spin text-3xl vintage-text-secondary mb-4"></i>
            <p class="vintage-text-primary text-lg font-semibold mb-2">📍 Loading Nearby Stores...</p>
            <p class="text-sm vintage-text-muted">Discovering nearby stores in your area</p>
        </div>
    </div>

    <!-- Google Maps Style Header -->
    <header class="fixed top-0 left-0 right-0 z-40">
        <!-- Main Search Bar (Google Maps Style) -->
        <div class="px-3 sm:px-4 py-3 sm:py-4 relative">
            <!-- User Controls (Top Right of Header) -->
            <div class="absolute top-3 sm:top-4 right-3 sm:right-4 flex items-center space-x-2 sm:space-x-3 z-10">
                <!-- Collections Button -->
                <button id="collectionsToggleBtn" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-center transition-colors shadow-lg border border-gray-200 dark:border-gray-600" title="Collections">
                    <i class="fas fa-archive text-gray-600 dark:text-gray-400 text-sm sm:text-lg"></i>
                </button>
                
                <!-- Profile Button -->
                <button id="profileBtn" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full overflow-hidden border-2 border-gray-200 dark:border-gray-600 hover:border-primary transition-colors shadow-lg" title="Profile">
                    <img id="userAvatar" src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=40&amp;h=40&amp;fit=crop&amp;crop=face" alt="Profile" class="w-full h-full object-cover">
                </button>
            </div>
            
            <div class="relative">
                <!-- Search Bar Container -->
                <div class="bg-white dark:bg-gray-800 rounded-full shadow-md border border-gray-200 dark:border-gray-600 flex items-center px-4 py-3 mr-[100px] sm:mr-[136px]">
                    <!-- App Icon/Logo -->
                    <div class="flex items-center mr-3">
                        <div class="w-6 h-6 sm:w-7 sm:h-7 bg-gradient-to-br from-amber-600 to-amber-800 rounded-full flex items-center justify-center">
                            <i class="fas fa-map text-white text-xs sm:text-sm"></i>
                        </div>
                    </div>
                    
                    <!-- Search Input -->
                    <input type="text" id="searchInput" placeholder="Search nearby stores..." class="flex-1 text-base sm:text-lg text-gray-700 dark:text-gray-300 placeholder-gray-500 dark:placeholder-gray-400 bg-transparent focus:outline-none">
                </div>
            </div>
        </div>
        
    </header>
    
    <!-- Floating Action Buttons -->
    <div class="fixed top-20 left-1/2 transform -translate-x-1/2 flex space-x-3 sm:space-x-4 z-30">
        <!-- Recommendations Button -->
        <button id="getRecommendationsBtn" class="flex items-center justify-center px-4 py-2 vintage-button vintage-shadow rounded-full transition-all hover:scale-105" title="Get Recommendations">
            <i class="fas fa-star text-sm mr-2"></i>
            <span class="text-sm font-medium">Recommendations</span>
        </button>
    </div>

    <div class="fixed bottom-5 right-5 z-30">
        <!-- Location Button -->
        <button id="getCurrentLocationBtn" class="flex items-center justify-center px-4 py-4 vintage-legend vintage-shadow hover:scale-105 rounded-full transition-all vintage-border" title="Update Current Location">
            <i class="fas fa-location-arrow"></i>
        </button>
    </div>

    <!-- Map Legend -->
    <div class="fixed bottom-5 left-5 vintage-legend vintage-shadow
                p-1.5 xs:p-2 sm:p-2.5 md:p-3 lg:p-3.5 xl:p-4
                z-30 
                max-w-[140px] xs:max-w-[160px] sm:max-w-[180px] md:max-w-[200px] lg:max-w-[220px] xl:max-w-none
                transform transition-all duration-300 ease-in-out hover:scale-105
                mobile-landscape-legend-adaptive">
        <div class="space-y-0.5 xs:space-y-1 sm:space-y-1.5 md:space-y-2 
                    text-[10px] xs:text-xs sm:text-xs md:text-sm lg:text-sm xl:text-base">
            <div class="flex items-center">
                <span class="text-sm xs:text-base sm:text-lg md:text-xl lg:text-xl xl:text-2xl 
                           mr-1 xs:mr-1.5 sm:mr-2 md:mr-2.5 lg:mr-3 xl:mr-3.5 
                           flex-shrink-0">📍</span>
                <span class="vintage-text-primary truncate font-medium">
                    <span class="hidden sm:inline">Nearby Store</span>
                    <span class="sm:hidden">Store</span>
                </span>
            </div>
            <div class="flex items-center">
                <span class="text-sm xs:text-base sm:text-lg md:text-xl lg:text-xl xl:text-2xl 
                           mr-1 xs:mr-1.5 sm:mr-2 md:mr-2.5 lg:mr-3 xl:mr-3.5 
                           flex-shrink-0">⭐</span>
                <span class="vintage-text-primary truncate font-medium">
                    <span class="hidden sm:inline">Recommendation</span>
                    <span class="sm:hidden">REC</span>
                </span>
            </div>
        </div>
    </div>

    <!-- Store List Panel Overlay -->
    <div id="storeListOverlay" class="fixed inset-0 bg-black bg-opacity-25 z-40 hidden transition-opacity duration-300"></div>
    
    <!-- Store List Panel -->
    <div id="storeListPanel" class="fixed bottom-0 left-0 right-0 vintage-panel vintage-shadow z-40 transform translate-y-full transition-transform duration-300">
        <div class="p-4">
            <!-- Panel Handle (Draggable) -->
            <div id="panelHandle" class="w-12 h-2 bg-gradient-to-r from-amber-600 to-amber-800 rounded-full mx-auto mb-4 cursor-pointer"></div>
            
            <!-- Tabs and Close Button -->
            <div class="flex items-center gap-3 mb-4">
                <div class="flex flex-1 vintage-border p-1">
                    <button id="nearbyTab" class="flex-1 py-2 px-4 text-sm font-medium transition-all duration-200 vintage-tab-active vintage-shadow">
                        📍 Nearby Stores
                    </button>
                    <button id="aiTab" class="flex-1 py-2 px-4 text-sm font-medium transition-all duration-200 vintage-tab-inactive">
                        ⭐ Recommendations
                        <span id="aiTabBadge" class="ml-2 bg-amber-700 text-white text-xs px-2 py-1 rounded hidden">2</span>
                    </button>
                </div>
                <button id="closeStorePanel" class="vintage-button p-2 transition-all flex-shrink-0">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Tab Content -->
            <div class="max-h-96 overflow-y-auto">
                <!-- Nearby Stores Tab -->
                <div id="nearbyTabContent" class="space-y-3">
                    <!-- All stores will be populated here -->
                </div>
                
                <!-- Recommendations Tab -->
                <div id="aiTabContent" class="hidden">
                    <div id="aiRecommendationsEmpty" class="text-center py-12">
                        <i class="fas fa-compass text-4xl vintage-text-secondary mb-4"></i>
                        <h4 class="text-lg font-semibold vintage-text-primary mb-2">📍 No Locations Analyzed Yet</h4>
                        <p class="text-sm vintage-text-muted mb-4">Let our analysis find the most notable historical locations for you!</p>
                        <button onclick="document.getElementById('getRecommendationsBtn').click(); document.getElementById('closeStorePanel').click();" class="vintage-button px-4 py-2 text-sm font-medium transition-all">
                            <i class="fas fa-map mr-2"></i>
                            🗺️ Analyze Locations
                        </button>
                    </div>
                    <div id="aiRecommendationsList" class="space-y-3 hidden">
                        <!-- Recommended stores will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Show Stores Button -->
    <button id="showStoresBtn" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 vintage-button px-4 py-2 vintage-shadow z-30 rounded-full transition-all hover:scale-105">
        <span class="font-medium">📍 View Nearby Stores</span>
    </button>

    <!-- Collections Overlay -->
    <div id="collectionsOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="fixed inset-y-0 right-0 w-full max-w-md vintage-card vintage-shadow transform translate-x-full transition-transform duration-300" id="collectionsPanel">
            <div class="h-full flex flex-col">
                <!-- Collections Header -->
                <div class="vintage-header text-white p-4 flex items-center justify-between rounded-t-lg">
                    <h2 class="text-lg font-bold">📚 Collections</h2>
                    <button id="closeCollectionsBtn" class="vintage-button p-2 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Create Post Button -->
                <div class="p-4 border-b vintage-border bg-amber-50">
                    <button id="createPostBtn" class="w-full vintage-button px-4 py-3 font-medium transition-colors flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i>
                        📜 Share Your Archive
                    </button>
                </div>
                
                <!-- Collection Feed -->
                <div class="flex-1 overflow-y-auto p-4 vintage-legend">
                    <div id="collectionFeed" class="space-y-6">
                        <!-- Posts will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations Loading Overlay -->
    <div id="recommendationsLoading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="vintage-card vintage-shadow p-8 mx-4 max-w-sm w-full text-center">
            <i class="fas fa-compass text-4xl vintage-text-secondary mb-4"></i>
            <h3 class="text-lg font-bold vintage-text-primary mb-2">📍 Location Analysis in Progress</h3>
            <div class="flex items-center justify-center mb-4">
                <i class="fas fa-spinner fa-spin text-2xl vintage-text-secondary mr-3"></i>
                <p class="vintage-text-muted">Analyzing historical significance...</p>
            </div>
            <div class="bg-gradient-to-r from-amber-50 to-amber-100 dark:from-amber-900 dark:to-amber-800 rounded-lg p-3 vintage-border">
                <p class="text-xs vintage-text-muted">
                    <i class="fas fa-info-circle mr-1"></i>
                    Finding the most notable locations based on historical importance
                </p>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="vintage-card vintage-shadow w-full max-w-md mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold vintage-text-primary">📜 Share Your Archive</h3>
                    <button id="closeModalBtn" class="vintage-button p-2 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="createPostForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium vintage-text-primary mb-2">📸 Photo URL</label>
                        <input type="url" id="postImageUrl" placeholder="https://example.com/your-historical-photo.jpg" class="w-full px-3 py-2 text-base vintage-search focus:outline-none vintage-text-primary">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium vintage-text-primary mb-2">📝 Description</label>
                        <textarea id="postDescription" rows="3" placeholder="Tell us about your historical findings..." class="w-full px-3 py-2 text-base vintage-search focus:outline-none vintage-text-primary"></textarea>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium vintage-text-primary mb-2">🏷️ Tags</label>
                        <input type="text" id="postTags" placeholder="historical, maps, collectibles, vintage" class="w-full px-3 py-2 text-base vintage-search focus:outline-none vintage-text-primary">
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" id="cancelPostBtn" class="flex-1 vintage-button px-4 py-2 transition-colors">Cancel</button>
                        <button type="submit" class="flex-1 vintage-button px-4 py-2 transition-colors">📜 Share Archive</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Google Maps and Places variables
        let map;
        let service;
        let infoWindow;
        let userLocation;
        let userLocationMarker = null;
        let toyStores = [];
        let storeMarkers = [];
        let isMapInitialized = false;

        const samplePosts = [
            {
                id: 1,
                user: 'ActionFigureFan',
                avatar: 'https://images.unsplash.com/photo-1527980965255-d3b416303d12?w=40&h=40&fit=crop&crop=face',
                image: 'https://images.unsplash.com/photo-1558877385-1c2d4c6eae1d?w=500&h=500&fit=crop',
                description: 'Just completed my Marvel Legends collection! The details on these figures are incredible. Took me 2 years to find all of them!',
                tags: ['marvel', 'action-figures', 'collectibles'],
                likes: 47,
                comments: 12,
                timeAgo: '2 hours ago'
            },
            {
                id: 2,
                user: 'LEGOMaster',
                avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=40&h=40&fit=crop&crop=face',
                image: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=500&h=500&fit=crop',
                description: 'My custom LEGO city is finally complete! Features working lights and a monorail system. What do you think?',
                tags: ['lego', 'custom-build', 'city'],
                likes: 89,
                comments: 23,
                timeAgo: '5 hours ago'
            },
            {
                id: 3,
                user: 'VintageToyHunter',
                avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face',
                image: 'https://images.unsplash.com/photo-1515594313313-31e145e8e8e4?w=500&h=500&fit=crop',
                description: 'Found this rare 1980s Transformer at a local antique shop! Still in original packaging. Sometimes the best finds are in unexpected places.',
                tags: ['vintage', 'transformers', 'rare-find'],
                likes: 134,
                comments: 31,
                timeAgo: '1 day ago'
            }
        ];

        // DOM elements
        const collectionFeed = document.getElementById('collectionFeed');
        const createPostBtn = document.getElementById('createPostBtn');
        const createPostModal = document.getElementById('createPostModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelPostBtn = document.getElementById('cancelPostBtn');
        const createPostForm = document.getElementById('createPostForm');

        // Store recommendation tracking
        let recommendedStores = [];
        let topMatchStore = null;

        // Render recommendation card similar to store list cards
        function renderRecommendationCard(store, isTopMatch, isRecommended) {
            if (!store) {
                return '<div class="text-gray-500 dark:text-gray-400 text-sm">Store information not available</div>';
            }

            const badgeHtml = isTopMatch 
                ? '<div class="flex items-center mb-2"><span class="text-xs bg-green-500 text-white px-2 py-1 rounded-full flex items-center"><i class="fas fa-crown mr-1"></i>Top Match</span></div>'
                : '<div class="flex items-center mb-2"><span class="text-xs bg-yellow-400 text-gray-900 px-2 py-1 rounded-full flex items-center"><i class="fas fa-robot mr-1"></i>Recommended</span></div>';
            
            const borderClass = isTopMatch 
                ? 'ring-2 ring-green-200 dark:ring-green-600 border-green-200 dark:border-green-600'
                : 'ring-2 ring-yellow-200 dark:ring-yellow-600 border-yellow-200 dark:border-yellow-600';

            const reasoningText = isTopMatch
                ? 'Perfect for vintage collectibles and unique finds. Their handmade toys section and personalized service make this store ideal for your interests. Highest customer satisfaction rating.'
                : 'Great selection of action figures and LEGO sets. Family-friendly environment with competitive prices and extensive inventory for current collectibles.';

            return `
                <div onclick="focusStoreOnMap('${store.id}')" class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border ${borderClass} hover:shadow-md hover:scale-[1.02] transition-all cursor-pointer">
                    ${badgeHtml}
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-900 dark:text-white">${store.name}</h4>
                        <div class="flex items-center text-yellow-500">
                            <i class="fas fa-star mr-1"></i>
                            <span class="text-sm">${store.rating}</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${store.address}</p>
                    <p class="text-sm text-primary font-medium mb-2">${store.distance} away</p>
                    
                    <!-- Specialties -->
                    <div class="flex flex-wrap gap-1 mb-3">
                        ${store.specialties.map(spec => `
                            <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded">${spec}</span>
                        `).join('')}
                    </div>
                    
                    <!-- AI Reasoning -->
                    <div class="bg-blue-50 dark:bg-blue-900 rounded-lg p-3 mb-3">
                        <h6 class="text-xs font-semibold text-blue-800 dark:text-blue-200 mb-1 flex items-center">
                            <i class="fas fa-brain mr-1"></i>
                            Why AI Recommends This Store
                        </h6>
                        <p class="text-xs text-blue-700 dark:text-blue-300">${reasoningText}</p>
                    </div>
                    
                    <!-- Store Details -->
                    <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                        <div class="flex items-center justify-between">
                            <span><i class="fas fa-clock mr-1"></i>${store.hours}</span>
                            ${isTopMatch ? '<span class="text-green-600 dark:text-green-400 font-medium">🎯 Best Match</span>' : '<span class="text-yellow-600 dark:text-yellow-400 font-medium">🤖 AI Pick</span>'}
                        </div>
                    </div>
                    
                    <!-- Action Button -->
                    <div class="mt-3 pt-2 border-t border-gray-200 dark:border-gray-600">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center text-blue-500 dark:text-blue-400 text-xs">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                <span>Click to view on map</span>
                            </div>
                            <div class="text-xs">
                                ${isTopMatch 
                                    ? '<span class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-2 py-1 rounded-full">Perfect Match</span>'
                                    : '<span class="bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 px-2 py-1 rounded-full">Recommended</span>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Tab Management
        let activeTab = 'nearby'; // 'nearby' or 'ai'

        // Tab switching functionality
        document.getElementById('nearbyTab').addEventListener('click', () => {
            switchToTab('nearby');
        });

        document.getElementById('aiTab').addEventListener('click', () => {
            switchToTab('ai');
        });

        function switchToTab(tabName) {
            activeTab = tabName;
            
            // Update tab buttons
            const nearbyTab = document.getElementById('nearbyTab');
            const aiTab = document.getElementById('aiTab');
            const nearbyContent = document.getElementById('nearbyTabContent');
            const aiContent = document.getElementById('aiTabContent');
            
            if (tabName === 'nearby') {
                // Activate nearby tab
                nearbyTab.className = 'flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200 bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
                aiTab.className = 'flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white';
                
                // Show/hide content
                nearbyContent.classList.remove('hidden');
                aiContent.classList.add('hidden');
            } else {
                // Activate AI tab
                aiTab.className = 'flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200 bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
                nearbyTab.className = 'flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white';
                
                // Show/hide content
                aiContent.classList.remove('hidden');
                nearbyContent.classList.add('hidden');
            }
        }

        // Populate store lists
        function renderStores() {
            renderNearbyStores();
            renderAIRecommendations();
        }

        function renderNearbyStores() {
            const nearbyContent = document.getElementById('nearbyTabContent');
            if (!nearbyContent) {
                console.error('nearbyTabContent element not found');
                return;
            }
            
            nearbyContent.innerHTML = toyStores.map(store => {
                const isRecommended = recommendedStores.includes(store.id);
                const isTopMatch = topMatchStore === store.id;
                
                let badgeHtml = '';
                if (isTopMatch) {
                    badgeHtml = '<div class="flex items-center mb-2"><span class="text-xs bg-green-500 text-white px-2 py-1 rounded-full flex items-center"><i class="fas fa-crown mr-1"></i>Top Match</span></div>';
                } else if (isRecommended) {
                    badgeHtml = '<div class="flex items-center mb-2"><span class="text-xs bg-yellow-400 text-gray-900 px-2 py-1 rounded-full flex items-center"><i class="fas fa-robot mr-1"></i>Recommended</span></div>';
                }
                
                return `
                    <div onclick="focusStoreOnMap('${store.id}')" class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all cursor-pointer ${isRecommended ? 'ring-2 ring-yellow-200 dark:ring-yellow-600' : ''} ${isTopMatch ? 'ring-2 ring-green-200 dark:ring-green-600' : ''}">
                        ${badgeHtml}
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-900 dark:text-white">${store.name}</h4>
                            <div class="flex items-center text-yellow-500">
                                <i class="fas fa-star mr-1"></i>
                                <span class="text-sm">${store.rating}</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${store.address}</p>
                        <p class="text-sm text-primary font-medium mb-2">${store.distance} away</p>
                        <div class="flex flex-wrap gap-1 mb-2">
                            ${store.specialties.map(spec => `
                                <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded">${spec}</span>
                            `).join('')}
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${store.hours}</p>
                        ${isTopMatch ? '<div class="mt-2"><p class="text-xs text-green-600 dark:text-green-400 font-medium">🎯 Perfect match for your preferences!</p></div>' : ''}
                        ${isRecommended && !isTopMatch ? '<div class="mt-2"><p class="text-xs text-yellow-600 dark:text-yellow-400 font-medium">🤖 Recommended by AI</p></div>' : ''}
                        <div class="mt-3 pt-2 border-t border-gray-200 dark:border-gray-600">
                            <div class="flex items-center text-blue-500 dark:text-blue-400 text-xs">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                <span>Click to view on map</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAIRecommendations() {
            const aiRecommendationsList = document.getElementById('aiRecommendationsList');
            const aiRecommendationsEmpty = document.getElementById('aiRecommendationsEmpty');
            const aiTabBadge = document.getElementById('aiTabBadge');
            
            if (!aiRecommendationsList || !aiRecommendationsEmpty || !aiTabBadge) {
                console.error('Recommendations elements not found');
                return;
            }
            
            // Check if we have Recommendations
            if (recommendedStores.length === 0 && !topMatchStore) {
                // No recommendations - show empty state
                aiRecommendationsEmpty.classList.remove('hidden');
                aiRecommendationsList.classList.add('hidden');
                aiTabBadge.classList.add('hidden');
                
                // Update empty state message based on whether AI was attempted
                if (window.aiRecommendationsAttempted) {
                    aiRecommendationsEmpty.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-robot text-4xl text-gray-400 dark:text-gray-500 mb-4"></i>
                            <h4 class="text-lg font-semibold text-gray-600 dark:text-gray-400 mb-2">No Recommendations Found</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-500 mb-4">AI analysis completed but couldn't find suitable recommendations based on your preferences and nearby stores.</p>
                            <button onclick="document.getElementById('getRecommendationsBtn').click(); document.getElementById('closeStorePanel').click();" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark transition-colors text-sm font-medium">
                                <i class="fas fa-redo mr-2"></i>
                                Try Recommendations Again
                            </button>
                        </div>
                    `;
                } else {
                    aiRecommendationsEmpty.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-robot text-4xl text-gray-400 dark:text-gray-500 mb-4"></i>
                            <h4 class="text-lg font-semibold text-gray-600 dark:text-gray-400 mb-2">No Recommendations Yet</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-500 mb-4">Click "Get Recommendations" button to get personalized store suggestions based on your preferences.</p>
                            <button onclick="document.getElementById('getRecommendationsBtn').click(); document.getElementById('closeStorePanel').click();" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark transition-colors text-sm font-medium">
                                <i class="fas fa-sparkles mr-2"></i>
                                Get Recommendations
                            </button>
                        </div>
                    `;
                }
                return;
            }
            
            // Hide empty state and show recommendations
            aiRecommendationsEmpty.classList.add('hidden');
            aiRecommendationsList.classList.remove('hidden');
            
            // Update badge count
            const totalRecommendations = recommendedStores.length + (topMatchStore ? 1 : 0);
            if (totalRecommendations > 0) {
                aiTabBadge.textContent = totalRecommendations;
                aiTabBadge.classList.remove('hidden');
            }
            
            // Get recommended stores
            const aiRecommendedStores = [];
            
            // Add top match first if exists
            if (topMatchStore) {
                const topStore = toyStores.find(s => s.id === topMatchStore);
                if (topStore) {
                    aiRecommendedStores.push({ store: topStore, isTopMatch: true, isRecommended: false });
                }
            }
            
            // Add recommended stores
            recommendedStores.forEach(storeId => {
                if (storeId !== topMatchStore) { // Don't duplicate top match
                    const store = toyStores.find(s => s.id === storeId);
                    if (store) {
                        aiRecommendedStores.push({ store, isTopMatch: false, isRecommended: true });
                    }
                }
            });
            
            // Render Recommendations with enhanced cards
            aiRecommendationsList.innerHTML = aiRecommendedStores.map(({ store, isTopMatch, isRecommended }) => 
                renderRecommendationCard(store, isTopMatch, isRecommended)
            ).join('');
        }

        // Populate collection feed
        function renderCollectionFeed() {
            if (!collectionFeed) {
                console.error('collectionFeed element not found');
                return;
            }
            
            collectionFeed.innerHTML = samplePosts.map(post => `
                <div class="vintage-card vintage-shadow overflow-hidden">
                    <!-- Post Header -->
                    <div class="p-4 flex items-center space-x-3 border-b border-amber-200">
                        <img src="${post.avatar}" alt="${post.user}" class="w-10 h-10 rounded-full border-2 border-amber-300">
                        <div class="flex-1">
                            <h4 class="font-semibold vintage-text-primary">${post.user}</h4>
                            <p class="text-sm vintage-text-muted">${post.timeAgo}</p>
                        </div>
                        <button class="vintage-text-muted hover:vintage-text-secondary transition-colors">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </div>
                    
                    <!-- Post Image -->
                    <img src="${post.image}" alt="Collection" class="w-full h-64 object-cover">
                    
                    <!-- Post Content -->
                    <div class="p-4 bg-amber-50">
                        <div class="flex items-center space-x-4 mb-3">
                            <button class="flex items-center space-x-2 vintage-text-secondary hover:text-red-600 transition-colors">
                                <i class="far fa-heart"></i>
                                <span>${post.likes}</span>
                            </button>
                            <button class="flex items-center space-x-2 vintage-text-secondary hover:text-amber-700 transition-colors">
                                <i class="far fa-comment"></i>
                                <span>${post.comments}</span>
                            </button>
                            <button class="vintage-text-secondary hover:text-amber-700 transition-colors">
                                <i class="far fa-share-square"></i>
                            </button>
                        </div>
                        
                        <p class="vintage-text-primary mb-2">${post.description}</p>
                        
                        <div class="flex flex-wrap gap-1">
                            ${post.tags.map(tag => `
                                <span class="text-sm text-amber-700 hover:text-amber-800 cursor-pointer font-medium">#${tag}</span>
                            `).join(' ')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Modal handling
        createPostBtn.addEventListener('click', () => {
            createPostModal.classList.remove('hidden');
            createPostModal.style.zIndex = '80';
        });

        [closeModalBtn, cancelPostBtn].forEach(btn => {
            btn.addEventListener('click', () => {
                createPostModal.classList.add('hidden');
                createPostForm.reset();
            });
        });

        // Create post form
        createPostForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const imageUrl = document.getElementById('postImageUrl').value;
            const description = document.getElementById('postDescription').value;
            const tags = document.getElementById('postTags').value;

            if (!imageUrl || !description) {
                showAlert('Please fill in all required fields');
                return;
            }

            // Add new post to feed
            const newPost = {
                id: Date.now(),
                user: 'ToyCollector123',
                avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=40&h=40&fit=crop&crop=face',
                image: imageUrl,
                description: description,
                tags: tags.split(',').map(tag => tag.trim()),
                likes: 0,
                comments: 0,
                timeAgo: 'Just now'
            };

            samplePosts.unshift(newPost);
            renderCollectionFeed();
            createPostModal.classList.add('hidden');
            createPostForm.reset();
            
            showAlert('Your collection has been shared successfully!');
        });

        // Overlay UI Controls
        
        // Store Panel Drag Variables
        let isDragging = false;
        let startY = 0;
        let currentY = 0;
        let panelStartTransform = 0;
        const dragThreshold = 100; // Pixels to drag down to close

        // Show Stores Panel
        document.getElementById('showStoresBtn').addEventListener('click', () => {
            const panel = document.getElementById('storeListPanel');
            const overlay = document.getElementById('storeListOverlay');
            const btn = document.getElementById('showStoresBtn');
            
            // Show overlay first
            overlay.classList.remove('hidden');
            overlay.style.opacity = '1';
            
            // Show panel
            panel.classList.remove('translate-y-full');
            btn.style.display = 'none';
        });

        // Close Store Panel
        function closeStorePanel() {
            const panel = document.getElementById('storeListPanel');
            const overlay = document.getElementById('storeListOverlay');
            const btn = document.getElementById('showStoresBtn');
            
            // Reset header to default
            resetStorePanelHeader();
            
            // Hide panel
            panel.classList.add('translate-y-full');
            
            // Hide overlay
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 300);
            
            btn.style.display = 'block';
        }

        document.getElementById('closeStorePanel').addEventListener('click', closeStorePanel);

        // Tap outside to close
        document.getElementById('storeListOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'storeListOverlay') {
                closeStorePanel();
            }
        });

        // Drag to close functionality
        const panelHandle = document.getElementById('panelHandle');
        const storePanel = document.getElementById('storeListPanel');

        // Touch Events
        panelHandle.addEventListener('touchstart', handleDragStart);
        panelHandle.addEventListener('touchmove', handleDragMove);
        panelHandle.addEventListener('touchend', handleDragEnd);

        // Mouse Events (for desktop)
        panelHandle.addEventListener('mousedown', handleDragStart);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);

        function handleDragStart(e) {
            isDragging = true;
            startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            panelStartTransform = 0;
            
            // Disable transitions during drag
            storePanel.style.transition = 'none';
            
            // Prevent default touch behavior
            e.preventDefault();
        }

        function handleDragMove(e) {
            if (!isDragging) return;
            
            currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            const deltaY = currentY - startY;
            
            // Only allow dragging down
            if (deltaY > 0) {
                const translateY = panelStartTransform + deltaY;
                storePanel.style.transform = `translateY(${translateY}px)`;
                
                // Update overlay opacity based on drag distance
                const overlay = document.getElementById('storeListOverlay');
                const opacity = Math.max(0, 1 - (deltaY / 200));
                overlay.style.opacity = opacity;
            }
            
            e.preventDefault();
        }

        function handleDragEnd(e) {
            if (!isDragging) return;
            
            isDragging = false;
            
            // Re-enable transitions
            storePanel.style.transition = 'transform 0.3s ease-in-out';
            
            const deltaY = currentY - startY;
            
            // Check if dragged enough to close
            if (deltaY > dragThreshold) {
                closeStorePanel();
            } else {
                // Snap back to original position
                storePanel.style.transform = 'translateY(0)';
                document.getElementById('storeListOverlay').style.opacity = '1';
            }
            
            // Reset styles after animation
            setTimeout(() => {
                storePanel.style.transition = '';
                storePanel.style.transform = '';
            }, 300);
        }

        // Prevent drag on other panel elements
        storePanel.addEventListener('touchstart', (e) => {
            if (e.target !== panelHandle && !panelHandle.contains(e.target)) {
                e.stopPropagation();
            }
        });

        storePanel.addEventListener('mousedown', (e) => {
            if (e.target !== panelHandle && !panelHandle.contains(e.target)) {
                e.stopPropagation();
            }
        });

        // Collections Panel
        document.getElementById('collectionsToggleBtn').addEventListener('click', () => {
            console.log('Collections toggle button clicked');
            const overlay = document.getElementById('collectionsOverlay');
            const panel = document.getElementById('collectionsPanel');
            
            console.log('Overlay element:', overlay);
            console.log('Panel element:', panel);
            
            if (!overlay || !panel) {
                console.error('Collections elements not found!');
                return;
            }
            
            // Ensure overlay is visible with high z-index
            overlay.classList.remove('hidden');
            overlay.style.display = 'block';
            overlay.style.zIndex = '60'; // Higher than header (z-50)
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            
            console.log('Collections overlay should now be visible');
            
            setTimeout(() => {
                panel.classList.remove('translate-x-full');
                console.log('Collections panel should now slide in');
            }, 10);
        });

        document.getElementById('closeCollectionsBtn').addEventListener('click', () => {
            const overlay = document.getElementById('collectionsOverlay');
            const panel = document.getElementById('collectionsPanel');
            
            console.log('Closing collections panel');
            
            panel.classList.add('translate-x-full');
            setTimeout(() => {
                // Clear inline styles first, then add hidden class
                overlay.style.display = '';
                overlay.style.zIndex = '';
                overlay.style.position = '';
                overlay.style.inset = '';
                overlay.classList.add('hidden');
                
                console.log('Collections overlay hidden and styles cleared');
            }, 300);
        });

        // Close collections when clicking overlay
        document.getElementById('collectionsOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'collectionsOverlay') {
                document.getElementById('closeCollectionsBtn').click();
            }
        });

        // Recommendations Button
        document.getElementById('getRecommendationsBtn').addEventListener('click', async () => {
            // Show loading overlay
            document.getElementById('recommendationsLoading').classList.remove('hidden');

            try {
                if (window.Poe && window.Poe.sendUserMessage) {
                    // Register handler for Recommendations
                    window.Poe.registerHandler('toy-recommendations', (result) => {
                        if (result.status === 'complete') {
                            const response = result.responses[0];
                            
                            // Process AI response to extract store recommendations
                            processAIRecommendations(response.content);
                            
                            // Hide loading overlay
                            document.getElementById('recommendationsLoading').classList.add('hidden');
                            
                            // Show stores panel with recommendations
                            showStoresPanelWithRecommendations();
                        }
                    });

                    await window.Poe.sendUserMessage(
                        "@Claude-Sonnet-4 As a toy store recommendation AI, analyze these nearby stores and provide personalized recommendations: 1) Toys R Us (action figures, LEGO, board games), 2) Target Toys (dolls, educational toys, outdoor toys), 3) Walmart Toys (budget toys, electronic toys, craft supplies), 4) Little Dreamers Toy Shop (handmade toys, vintage collectibles, puzzles). User preferences: loves action figures, collects vintage toys, enjoys LEGO builds, has children aged 6-10, budget is moderate ($50-200 per item). Which stores should they prioritize and why? Mention specific store names. Provide ONLY raw JSON in your response with no explanations, additional text, or code block formatting (no ```) with this structure: {\"topMatch\": \"store_name\", \"recommended\": [\"store1\", \"store2\"], \"reasoning\": \"explanation\"}",
                        {
                            handler: 'toy-recommendations',
                            stream: false,
                            openChat: false
                        }
                    );
                } else {
                    // Fallback mock recommendations with map integration
                    setTimeout(() => {
                        // Set mock recommendations
                        recommendedStores = ['local', 'toysrus'];
                        topMatchStore = 'local';
                        
                        // Update map and store list
                        updateMapPins();
                        renderStores();
                        
                        // Hide loading overlay
                        document.getElementById('recommendationsLoading').classList.add('hidden');
                        
                        // Show stores panel with recommendations
                        showStoresPanelWithRecommendations();
                    }, 2000);
                }
            } catch (error) {
                document.getElementById('recommendationsLoading').classList.add('hidden');
                showAlert('Unable to get Recommendations at this time. Please try again later.');
            }
        });

        // Show stores panel with Recommendations highlighted
        function showStoresPanelWithRecommendations() {
            const panel = document.getElementById('storeListPanel');
            const btn = document.getElementById('showStoresBtn');
            
            // Show the panel
            panel.classList.remove('translate-y-full');
            btn.style.display = 'none';
            
            // Switch to AI tab automatically
            switchToTab('ai');
            
            // Show success toast
            showAIRecommendationsToast();
        }

        // Reset panel header when closing
        function resetStorePanelHeader() {
            const header = document.querySelector('#storeListPanel h3');
            if (header) {
                header.innerHTML = 'Nearby Stores';
            }
        }

        // Show Recommendations success toast
        function showAIRecommendationsToast() {
            const toast = document.createElement('div');
            toast.className = 'fixed top-24 left-1/2 transform -translate-x-1/2 bg-primary text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-sparkles"></i>
                    <div>
                        <div class="text-sm font-medium">Recommendations Ready!</div>
                        <div class="text-xs opacity-90">Recommended stores are highlighted below</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translate(-50%, 0)';
            }, 10);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Clear Recommendations (confirmed)
        function confirmCloseRecommendations() {
            // Close confirmation dialog (with safety check)
            const dialog = document.querySelector('.fixed.z-60');
            if (dialog) {
                dialog.remove();
            }
            
            // Clear the recommendations data
            recommendedStores = [];
            topMatchStore = null;
            
            // Reset panel header
            resetStorePanelHeader();
            
            // Update map to remove highlights
            updateMapPins();
            renderStores();
            
            // Show goodbye toast
            showCloseToast();
        }

        // Hide recommendations instead of closing (from confirmation dialog)
        function minimizeInsteadOfClose() {
            // Close the confirmation dialog (with safety check)
            const dialog = document.querySelector('.fixed.z-60');
            if (dialog) {
                dialog.remove();
            }
            
            // Close the store panel but keep recommendations data
            const panel = document.getElementById('storeListPanel');
            const btn = document.getElementById('showStoresBtn');
            
            // Reset header to default
            resetStorePanelHeader();
            
            panel.classList.add('translate-y-full');
            btn.style.display = 'block';
            
            // Show helpful toast
            showMinimizeToast();
        }

        // Show toast when minimizing instead of closing
        function showMinimizeToast() {
            const toast = document.createElement('div');
            toast.className = 'fixed top-24 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <div class="text-sm font-medium">Recommendations minimized!</div>
                        <div class="text-xs opacity-90">Click the widget anytime to restore</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translate(-50%, 0)';
            }, 10);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Show toast when closing recommendations
        function showCloseToast() {
            const toast = document.createElement('div');
            toast.className = 'fixed top-24 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <div class="text-sm font-medium">Recommendations cleared</div>
                        <div class="text-xs opacity-90">Click "Recommendations" to get new suggestions</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translate(-50%, 0)';
            }, 10);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Make functions globally available
        window.minimizeInsteadOfClose = minimizeInsteadOfClose;
        window.confirmCloseRecommendations = confirmCloseRecommendations;

        // Process Recommendations to update map
        function processAIRecommendations(content) {
            // Mark that Recommendations have been attempted
            window.aiRecommendationsAttempted = true;
            
            try {
                // Try to parse JSON response from AI
                const aiResponse = JSON.parse(content);
                
                // Map store names to IDs
                const storeNameToId = {
                    'Toys R Us': 'toysrus',
                    'Target Toys': 'target', 
                    'Walmart Toys': 'walmart',
                    'Little Dreamers Toy Shop': 'local'
                };
                
                // Set top match
                if (aiResponse.topMatch && storeNameToId[aiResponse.topMatch]) {
                    topMatchStore = storeNameToId[aiResponse.topMatch];
                }
                
                // Set recommended stores
                if (aiResponse.recommended && Array.isArray(aiResponse.recommended)) {
                    recommendedStores = aiResponse.recommended
                        .map(storeName => storeNameToId[storeName])
                        .filter(id => id); // Remove undefined values
                }
                
                // If AI response has no valid recommendations, clear everything
                if (!topMatchStore && recommendedStores.length === 0) {
                    console.log('AI returned no valid recommendations');
                }
                
                // Update map and store list
                updateMapPins();
                renderStores();
                
            } catch (error) {
                console.log('Failed to parse AI response as JSON, using fallback recommendations');
                // Fallback to mock recommendations
                recommendedStores = ['local', 'toysrus'];
                topMatchStore = 'local';
                updateMapPins();
                renderStores();
            }
        }

        // Custom alert function
        function showAlert(message) {
            const alertModal = document.createElement('div');
            alertModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            alertModal.style.zIndex = '90';
            alertModal.innerHTML = `
                <div class="vintage-card vintage-shadow p-6 max-w-sm w-full mx-4">
                    <p class="vintage-text-primary mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="vintage-button px-4 py-2 transition-colors" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(alertModal);
        }

        // Google Maps Initialization
        function initMap() {
            try {
                // Default location (San Francisco) if geolocation fails
                const defaultLocation = { lat: 37.7749, lng: -122.4194 };
                
                // Check if Google Maps is available
                if (typeof google === 'undefined' || !google.maps) {
                    console.error('Google Maps API not loaded');
                    showAlert('Map service is currently unavailable. Please refresh the page.');
                    return;
                }
                
                // Initialize map with vintage historical map styles
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 15,
                    center: defaultLocation,
		    disableDefaultUI: true,
                    styles: [
                        // Hide modern POI labels for clean vintage look
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        },
                        {
                            featureType: 'poi.business',
                            stylers: [{ visibility: 'off' }]
                        },
                        // Vintage water styling - muted blue-grey
                        {
                            featureType: 'water',
                            elementType: 'geometry',
                            stylers: [{ color: '#9db4a8' }]
                        },
                        {
                            featureType: 'water',
                            elementType: 'labels.text.fill',
                            stylers: [{ color: '#5a6b5d' }]
                        },
                        // Vintage landscape - sepia/parchment tones
                        {
                            featureType: 'landscape',
                            elementType: 'geometry',
                            stylers: [{ color: '#f0ebe0' }]
                        },
                        {
                            featureType: 'landscape.natural',
                            elementType: 'geometry',
                            stylers: [{ color: '#e8ddd0' }]
                        },
                        // Main roads - vintage brown
                        {
                            featureType: 'road.highway',
                            elementType: 'geometry',
                            stylers: [{ color: '#c4a484' }]
                        },
                        {
                            featureType: 'road.highway',
                            elementType: 'geometry.stroke',
                            stylers: [{ color: '#a68b5b' }]
                        },
                        // Arterial roads - lighter brown
                        {
                            featureType: 'road.arterial',
                            elementType: 'geometry',
                            stylers: [{ color: '#d4c4a8' }]
                        },
                        {
                            featureType: 'road.arterial',
                            elementType: 'geometry.stroke',
                            stylers: [{ color: '#b8a888' }]
                        },
                        // Local roads - subtle beige
                        {
                            featureType: 'road.local',
                            elementType: 'geometry',
                            stylers: [{ color: '#e8ddd0' }]
                        },
                        {
                            featureType: 'road.local',
                            elementType: 'geometry.stroke',
                            stylers: [{ color: '#d4c4a8' }]
                        },
                        // Administrative boundaries - vintage ink lines
                        {
                            featureType: 'administrative',
                            elementType: 'geometry.stroke',
                            stylers: [{ color: '#8b7355' }, { weight: 1.5 }]
                        },
                        {
                            featureType: 'administrative.country',
                            elementType: 'geometry.stroke',
                            stylers: [{ color: '#6b5b47' }, { weight: 2 }]
                        },
                        // Vintage text styling
                        {
                            featureType: 'road',
                            elementType: 'labels.text.fill',
                            stylers: [{ color: '#5a4a3a' }]
                        },
                        {
                            featureType: 'road',
                            elementType: 'labels.text.stroke',
                            stylers: [{ color: '#f4f0e8' }, { weight: 2 }]
                        },
                        // Transit and buildings - muted tones
                        {
                            featureType: 'transit',
                            stylers: [{ visibility: 'simplified' }]
                        },
                        {
                            featureType: 'transit.line',
                            elementType: 'geometry',
                            stylers: [{ color: '#a68b5b' }]
                        },
                        {
                            featureType: 'administrative.locality',
                            elementType: 'labels.text.fill',
                            stylers: [{ color: '#4a3c2a' }]
                        },
                        // Parks and natural features
                        {
                            featureType: 'landscape.natural.landcover',
                            elementType: 'geometry',
                            stylers: [{ color: '#e0d5c7' }]
                        },
                        {
                            featureType: 'landscape.man_made',
                            elementType: 'geometry',
                            stylers: [{ color: '#ebe0d3' }]
                        }
                    ],
                    // Disable unwanted controls
                    streetViewControl: false,
                    rotateControl: false,
                    tilt: 0,
                    gestureHandling: 'greedy',
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_BOTTOM
                    },
                    mapTypeControlOptions: {
                        position: google.maps.ControlPosition.TOP_RIGHT,
                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
                    }
                });

                // Initialize info window
                infoWindow = new google.maps.InfoWindow();

                // Initialize Places service
                service = new google.maps.places.PlacesService(map);
                
                // Mark map as initialized
                isMapInitialized = true;

                // Try to get user's location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            map.setCenter(userLocation);
                            
                            // Add user location marker
                            userLocationMarker = new google.maps.Marker({
                                position: userLocation,
                                map: map,
                                title: 'Your Location',
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: '#4285F4',
                                    fillOpacity: 1,
                                    strokeColor: '#ffffff',
                                    strokeWeight: 2
                                }
                            });

                            // Search for toy stores near user location
                            searchToyStores(userLocation);
                        },
                        (error) => {
                            console.log('Geolocation error:', error);
                            // Geolocation failed, use default location
                            userLocation = defaultLocation;
                            searchToyStores(defaultLocation);
                        }
                    );
                } else {
                    // Browser doesn't support geolocation
                    userLocation = defaultLocation;
                    searchToyStores(defaultLocation);
                }

                // Hide loading overlay
                const loadingElement = document.getElementById('mapLoading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            } catch (error) {
                console.error('Error initializing map:', error);
                showAlert('Error loading map. Please refresh the page and try again.');
            }
        }

        // Search for multiple store types using Google Places API
        function searchToyStores(location) {
            // Protect UI elements at the start of store search
            console.log('🔍 Starting store search - protecting UI elements');
            ensureUIElementsVisibleEnhanced();
            
            if (!service || !isMapInitialized) {
                console.log('Service or map not ready, using fallback data');
                loadMockData();
                return;
            }

            // Show loading indicator for store search
            console.log('Starting store search for location:', location);

            // Multiple search keywords for different store types
            const searchKeywords = [
                'toys hobbies collectibles',
                'toys',
                'hobbies'
            ];

            let allResults = [];
            let completedSearches = 0;
            const totalSearches = searchKeywords.length;

            // Function to handle completion of all searches
            function handleSearchCompletion() {
                console.log(`Completed ${completedSearches}/${totalSearches} searches`);
                
                // Protect UI during search processing
                ensureUIElementsVisibleEnhanced();
                
                if (completedSearches === totalSearches) {
                    // Remove duplicates based on place_id
                    const uniqueResults = allResults.filter((result, index, self) => 
                        index === self.findIndex(r => r.place_id === result.place_id)
                    );
                    
                    console.log(`Found ${uniqueResults.length} unique stores total`);
                    
                    if (uniqueResults.length > 0) {
                        processToyStores(uniqueResults);
                    } else {
                        console.log('No stores found with any keywords, clearing store list');
                        // Clear stores instead of loading mock data
                        toyStores = [];
                        storeMarkers = [];
                        // Reset Recommendations when no stores found
                        recommendedStores = [];
                        topMatchStore = null;
                    }
                    
                    // Ensure stores are rendered and show stores button is available
                    setTimeout(() => {
                        renderStores();
                        
                        // Make sure Show Stores button is fully functional
                        const showStoresBtn = document.getElementById('showStoresBtn');
                        const storePanel = document.getElementById('storeListPanel');
                        
                        if (toyStores.length > 0 && showStoresBtn) {
                            // Reset button to full functionality when stores available
                            showStoresBtn.style.display = 'block';
                            showStoresBtn.disabled = false;
                            showStoresBtn.style.opacity = '1';
                            showStoresBtn.style.pointerEvents = 'auto';
                            
                            // Ensure panel is hidden so button can show
                            if (!storePanel.classList.contains('translate-y-full')) {
                                storePanel.classList.add('translate-y-full');
                            }
                            
                            console.log(`Show Stores button restored with ${toyStores.length} stores available`);

                            // Ensure the event listener is working by re-attaching it
                            ensureShowStoresButtonWorks();
                        } else {
                            // Hide show stores button when no stores found
                            if (showStoresBtn) {
                                showStoresBtn.style.display = 'none';
                            }
                            console.log('No stores found - hiding show stores button');
                        }
                    }, 200);
                }
            }

            // Search for each keyword
            searchKeywords.forEach((keyword, index) => {
                const request = {
                    location: location,
                    radius: 5000, // 5km radius
                    keyword: keyword,
                    type: 'Stores'
                };

                try {
                    // Add delay between requests to avoid rate limiting
                    setTimeout(() => {
                        service.nearbySearch(request, (results, status) => {
                            completedSearches++;
                            
                            if (status === google.maps.places.PlacesServiceStatus.OK) {
                                console.log(`Found ${results.length} results for "${keyword}"`);
                                allResults = allResults.concat(results);
                            } else {
                                console.log(`Search failed for "${keyword}":`, status);
                            }
                            
                            handleSearchCompletion();
                        });
                    }, index * 200); // 200ms delay between each search
                } catch (error) {
                    console.error(`Error during search for "${keyword}":`, error);
                    completedSearches++;
                    handleSearchCompletion();
                }
            });
        }

        // Process toy store results from Google Places
        function processToyStores(places) {
            console.log('Processing', places.length, 'places from Google Places API');
            
            // Protect UI elements during store processing
            console.log('🛡️ Protecting UI during store processing...');
            ensureUIElementsVisibleEnhanced();
            
            // Clear existing data
            toyStores = [];
            storeMarkers = [];

            places.forEach((place, index) => {
                if (place.geometry && place.geometry.location) {
                    // Create store object
                    const store = {
                        id: `store_${index}`,
                        name: place.name,
                        address: place.vicinity || place.formatted_address || 'Address not available',
                        rating: place.rating || 'N/A',
                        distance: calculateDistance(userLocation, place.geometry.location),
                        specialties: getStoreSpecialties(place.name, place.types),
                        hours: 'Hours not available',
                        place_id: place.place_id,
                        location: {
                            lat: place.geometry.location.lat(),
                            lng: place.geometry.location.lng()
                        }
                    };

                    toyStores.push(store);
                    console.log('Added store:', store.name, 'at distance:', store.distance);

                    // Create map marker with emoji icon
                    const marker = new google.maps.Marker({
                        position: place.geometry.location,
                        map: map,
                        title: place.name,
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                                `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                                    <text x="16" y="24" font-size="20" text-anchor="middle" font-family="Arial, sans-serif">📍</text>
                                </svg>`
                            ),
                            scaledSize: new google.maps.Size(32, 32),
                            anchor: new google.maps.Point(16, 32)
                        }
                    });

                    // Add click listener to marker
                    marker.addListener('click', () => {
                        showStoreInfo(store, marker);
                    });

                    storeMarkers.push({ marker, store });

                    // Get detailed place information
                    getPlaceDetails(place.place_id, store);
                }
            });

            // Sort stores by distance
            toyStores.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
            console.log('Total stores processed:', toyStores.length);

            // Protect UI elements after processing stores
            console.log('🛡️ Final UI protection after store processing...');
            ensureUIElementsVisibleEnhanced();

            // Force immediate render of stores
            setTimeout(() => {
                renderStores();
                console.log('Store list rendered with', toyStores.length, 'stores');
                
                // Double-check store list content
                const nearbyContent = document.getElementById('nearbyTabContent');
                console.log('Nearby content HTML length:', nearbyContent.innerHTML.length);
                
                if (nearbyContent.innerHTML.length === 0 && toyStores.length > 0) {
                    console.warn('Store list is empty despite having stores! Force re-rendering...');
                    forceRenderStores();
                }
            }, 100);
        }

        // Get detailed information about a place
        function getPlaceDetails(placeId, store) {
            const request = {
                placeId: placeId,
                fields: ['opening_hours', 'formatted_phone_number', 'website', 'photos']
            };

            service.getDetails(request, (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    // Update store hours
                    if (place.opening_hours) {
                        const now = new Date();
                        const day = now.getDay();
                        if (place.opening_hours.periods && place.opening_hours.periods[day]) {
                            store.hours = place.opening_hours.isOpen() ? 
                                'Open now' : 'Closed';
                        }
                    }
                    
                    // Store additional details
                    store.phone = place.formatted_phone_number;
                    store.website = place.website;
                    store.photos = place.photos;

                    // Re-render stores to update information
                    renderStores();
                }
            });
        }

        // Calculate distance between two points
        function calculateDistance(pos1, pos2) {
            const lat1 = pos1.lat;
            const lng1 = pos1.lng;
            const lat2 = typeof pos2.lat === 'function' ? pos2.lat() : pos2.lat;
            const lng2 = typeof pos2.lng === 'function' ? pos2.lng() : pos2.lng;

            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            return distance.toFixed(1) + ' miles';
        }

        // Determine store specialties based on name and types
        function getStoreSpecialties(name, types) {
            const nameUpper = name.toUpperCase();
            const specialties = [];

            // Toy Store Specialties
            if (nameUpper.includes('TOYS R US') || nameUpper.includes('TOYSRUS')) {
                specialties.push('Action Figures', 'LEGO', 'Board Games');
            } else if (nameUpper.includes('TARGET')) {
                specialties.push('Dolls', 'Educational Toys', 'Outdoor Toys');
            } else if (nameUpper.includes('WALMART')) {
                specialties.push('Budget Toys', 'Electronic Toys', 'Craft Supplies');
            }
            
            // Hobby Store Specialties
            else if (nameUpper.includes('HOBBY') || nameUpper.includes('HOBBIES')) {
                specialties.push('Model Kits', 'RC Vehicles', 'Crafts', 'Train Sets');
            } else if (nameUpper.includes('CRAFT') || nameUpper.includes('ARTS')) {
                specialties.push('Art Supplies', 'DIY Kits', 'Scrapbooking', 'Painting');
            } else if (nameUpper.includes('MODEL')) {
                specialties.push('Scale Models', 'Model Trains', 'Model Cars', 'Model Planes');
            }
            
            // Gaming & Collectibles Specialties
            else if (nameUpper.includes('GAMESTOP') || nameUpper.includes('GAME')) {
                specialties.push('Video Games', 'Collectibles', 'Action Figures', 'Gaming Cards');
            } else if (nameUpper.includes('COMIC') || nameUpper.includes('COMICS')) {
                specialties.push('Comics', 'Graphic Novels', 'Collectible Cards', 'Pop Figures');
            } else if (nameUpper.includes('CARD') && nameUpper.includes('SHOP')) {
                specialties.push('Trading Cards', 'Pokemon Cards', 'Board Games', 'Card Games');
            }
            
            // Anime & Manga Specialties  
            else if (nameUpper.includes('ANIME') || nameUpper.includes('MANGA')) {
                specialties.push('Anime Figures', 'Manga Books', 'Cosplay Items', 'Japanese Imports');
            } else if (nameUpper.includes('JAPAN') || nameUpper.includes('OTAKU')) {
                specialties.push('Japanese Toys', 'Anime Collectibles', 'Gundam Models', 'Plushies');
            } else if (nameUpper.includes('FIGURINE') || nameUpper.includes('FIGURE')) {
                specialties.push('Action Figures', 'Collectible Figures', 'Display Models', 'Statues');
            }
            
            // Bookstores with toys
            else if (nameUpper.includes('BARNES') && nameUpper.includes('NOBLE')) {
                specialties.push('Educational Toys', 'Books', 'Puzzles', 'Board Games');
            } else if (nameUpper.includes('BOOK') && (nameUpper.includes('STORE') || nameUpper.includes('SHOP'))) {
                specialties.push('Educational Games', 'Puzzles', 'Learning Toys', 'Books');
            }
            
            // Generic categorization based on keywords in name
            else if (nameUpper.includes('TOY') || nameUpper.includes('PLAY')) {
                specialties.push('Toys', 'Games', 'Educational Toys');
            } else if (nameUpper.includes('COLLECT')) {
                specialties.push('Collectibles', 'Trading Cards', 'Memorabilia');
            } else if (nameUpper.includes('VINTAGE') || nameUpper.includes('ANTIQUE')) {
                specialties.push('Vintage Toys', 'Retro Games', 'Classic Collectibles');
            } else {
                // Default fallback specialties
                specialties.push('Toys', 'Games', 'Collectibles');
            }

            // Add additional specialties based on Google Places types
            if (types && Array.isArray(types)) {
                if (types.includes('book_store')) {
                    if (!specialties.includes('Books')) specialties.push('Books');
                    if (!specialties.includes('Educational Toys')) specialties.push('Educational Toys');
                }
                if (types.includes('electronics_store')) {
                    if (!specialties.includes('Electronic Toys')) specialties.push('Electronic Toys');
                    if (!specialties.includes('Video Games')) specialties.push('Video Games');
                }
                if (types.includes('clothing_store') || types.includes('shoe_store')) {
                    if (!specialties.includes('Costumes')) specialties.push('Costumes');
                    if (!specialties.includes('Dress-up')) specialties.push('Dress-up');
                }
            }

            return specialties;
        }

        // Show store information in info window
        function showStoreInfo(store, marker) {
            const content = `
                <div class="p-2">
                    <h3 class="font-bold text-lg">${store.name}</h3>
                    <p class="text-sm text-gray-600">${store.address}</p>
                    <div class="flex items-center mt-1">
                        <i class="fas fa-star text-yellow-500 mr-1"></i>
                        <span class="text-sm">${store.rating}</span>
                        <span class="mx-2">•</span>
                        <span class="text-sm">${store.distance}</span>
                    </div>
                    <div class="mt-2">
                        ${store.specialties.map(spec => 
                            `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1">${spec}</span>`
                        ).join('')}
                    </div>
                    <p class="text-xs text-gray-500 mt-2">${store.hours}</p>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        }

        // Update marker styles based on Recommendations
        function updateMarkerStyles() {
            storeMarkers.forEach(({ marker, store }) => {
                const isRecommended = recommendedStores.includes(store.id);
                const isTopMatch = topMatchStore === store.id;

                let emoji = '📍'; // Default pin marker
                let size = 32;

                if (isTopMatch) {
                    emoji = '🎯'; // Top match
                    size = 40;
                } else if (isRecommended) {
                    emoji = '🤖'; // Recommended
                    size = 36;
                }

                marker.setIcon({
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                        `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                            <text x="${size/2}" y="${size*0.75}" font-size="${size*0.625}" text-anchor="middle" font-family="Arial, sans-serif">${emoji}</text>
                        </svg>`
                    ),
                    scaledSize: new google.maps.Size(size, size),
                    anchor: new google.maps.Point(size/2, size)
                });
            });
        }

        // Override the updateMapPins function for Google Maps
        function updateMapPins() {
            updateMarkerStyles();
        }

        // Load mock data as fallback
        function loadMockData() {
            toyStores = [
                {
                    id: 'toysrus',
                    name: 'Toys R Us',
                    address: '123 Fun Street',
                    distance: '0.3 miles',
                    rating: 4.5,
                    specialties: ['Action Figures', 'LEGO', 'Board Games'],
                    hours: 'Open until 9 PM'
                },
                {
                    id: 'target',
                    name: 'Target Toys',
                    address: '456 Shopping Ave',
                    distance: '0.7 miles',
                    rating: 4.2,
                    specialties: ['Dolls', 'Educational Toys', 'Outdoor Toys'],
                    hours: 'Open until 10 PM'
                },
                {
                    id: 'hobby',
                    name: 'Hobby Haven',
                    address: '789 Craft Lane',
                    distance: '1.2 miles',
                    rating: 4.6,
                    specialties: ['Model Kits', 'RC Vehicles', 'Crafts', 'Train Sets'],
                    hours: 'Open until 8 PM'
                },
                {
                    id: 'anime',
                    name: 'Tokyo Dreams Anime Shop',
                    address: '555 Otaku Avenue',
                    distance: '0.8 miles',
                    rating: 4.7,
                    specialties: ['Anime Figures', 'Manga Books', 'Cosplay Items', 'Japanese Imports'],
                    hours: 'Open until 9 PM'
                },
                {
                    id: 'comics',
                    name: 'Comic & Card Emporium',
                    address: '321 Hero Street',
                    distance: '0.9 miles',
                    rating: 4.4,
                    specialties: ['Comics', 'Trading Cards', 'Pokemon Cards', 'Pop Figures'],
                    hours: 'Open until 7 PM'
                },
                {
                    id: 'vintage',
                    name: 'Retro Toy Vault',
                    address: '654 Nostalgia Drive',
                    distance: '1.5 miles',
                    rating: 4.8,
                    specialties: ['Vintage Toys', 'Retro Games', 'Classic Collectibles', 'Antique Figures'],
                    hours: 'Open until 6 PM'
                }
            ];
            renderStores();
            
            // Ensure Show Stores button is restored after loading mock data
            setTimeout(() => {
                const showStoresBtn = document.getElementById('showStoresBtn');
                if (showStoresBtn && toyStores.length > 0) {
                    showStoresBtn.style.display = 'block';
                    showStoresBtn.disabled = false;
                    showStoresBtn.style.opacity = '1';
                    showStoresBtn.style.pointerEvents = 'auto';
                    console.log('Show Stores button restored with mock data');
                }
            }, 100);
        }

        // Function to ensure Show Stores button functionality
        function ensureShowStoresButtonWorks() {
            const showStoresBtn = document.getElementById('showStoresBtn');
            if (!showStoresBtn) {
                console.error('Show Stores button not found!');
                return;
            }

            // Remove existing click handlers by cloning (this removes all event listeners)
            const newButton = showStoresBtn.cloneNode(true);
            showStoresBtn.parentNode.replaceChild(newButton, showStoresBtn);
            
            // Ensure button is fully functional
            newButton.disabled = false;
            newButton.style.display = 'block';
            newButton.style.opacity = '1';
            newButton.style.pointerEvents = 'auto';
            newButton.style.cursor = 'pointer';
            newButton.classList.remove('opacity-50', 'cursor-not-allowed');
            
            // Add fresh click event listener with robust element finding
            newButton.addEventListener('click', function(e) {
                console.log('Show Stores button clicked after relocation');
                e.preventDefault();
                e.stopPropagation();
                
                // More robust element finding with fallback creation
                let panel = document.getElementById('storeListPanel');
                let overlay = document.getElementById('storeListOverlay');
                const btn = document.getElementById('showStoresBtn');
                
                // Verify elements exist and create if missing
                if (!panel) {
                    console.error('Store panel not found!');
                    return;
                }
                
                if (!overlay) {
                    console.warn('Overlay not found, recreating...');
                    // Create overlay if it doesn't exist with LOWER z-index than header/search
                    overlay = document.createElement('div');
                    overlay.id = 'storeListOverlay';
                    overlay.className = 'fixed inset-0 bg-black bg-opacity-25 z-30 hidden transition-opacity duration-300';
                    document.body.appendChild(overlay);
                    
                    // Add click handler to close on overlay click
                    overlay.addEventListener('click', (e) => {
                        if (e.target.id === 'storeListOverlay') {
                            closeStorePanel();
                        }
                    });
                }
                
                if (!btn) {
                    console.error('Button reference lost!');
                    return;
                }
                
                try {
                    console.log('Opening store panel...');
                    
                    // Show overlay first
                    overlay.classList.remove('hidden');
                    overlay.style.opacity = '1';
                    
                    // Show panel
                    panel.classList.remove('translate-y-full');
                    btn.style.display = 'none';
                    
                    console.log('Store panel opened successfully');
                    
                    // Ensure stores are rendered in the panel
                    setTimeout(() => {
                        if (toyStores.length > 0) {
                            renderStores();
                            console.log('Stores re-rendered in panel');
                        }
                    }, 100);
                    
                } catch (error) {
                    console.error('Error opening store panel:', error);
                }
            });
            
            // Add touch event for mobile devices
            newButton.addEventListener('touchstart', function(e) {
                console.log('Show Stores button touched');
                // Prevent touch delay on mobile
                e.preventDefault();
                newButton.click();
            }, { passive: false });
            
            console.log('Show Stores button fully restored and functional');
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredStores = toyStores.filter(store => 
                store.name.toLowerCase().includes(searchTerm) ||
                store.specialties.some(spec => spec.toLowerCase().includes(searchTerm))
            );
            
            // Update nearby stores tab with filtered results
            const nearbyContent = document.getElementById('nearbyTabContent');
            nearbyContent.innerHTML = filteredStores.map(store => {
                const isRecommended = recommendedStores.includes(store.id);
                const isTopMatch = topMatchStore === store.id;
                
                let badgeHtml = '';
                if (isTopMatch) {
                    badgeHtml = '<div class="flex items-center mb-2"><span class="text-xs bg-green-500 text-white px-2 py-1 rounded-full flex items-center"><i class="fas fa-crown mr-1"></i>Top Match</span></div>';
                } else if (isRecommended) {
                    badgeHtml = '<div class="flex items-center mb-2"><span class="text-xs bg-yellow-400 text-gray-900 px-2 py-1 rounded-full flex items-center"><i class="fas fa-robot mr-1"></i>Recommended</span></div>';
                }
                
                return `
                    <div onclick="focusStoreOnMap('${store.id}')" class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md hover:scale-105 transition-all cursor-pointer ${isRecommended ? 'ring-2 ring-yellow-200 dark:ring-yellow-600' : ''} ${isTopMatch ? 'ring-2 ring-green-200 dark:ring-green-600' : ''}">
                        ${badgeHtml}
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-900 dark:text-white">${store.name}</h4>
                            <div class="flex items-center text-yellow-500">
                                <i class="fas fa-star mr-1"></i>
                                <span class="text-sm">${store.rating}</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${store.address}</p>
                        <p class="text-sm text-primary font-medium mb-2">${store.distance} away</p>
                        <div class="flex flex-wrap gap-1 mb-2">
                            ${store.specialties.map(spec => `
                                <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded">${spec}</span>
                            `).join('')}
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${store.hours}</p>
                        ${isTopMatch ? '<div class="mt-2"><p class="text-xs text-green-600 dark:text-green-400 font-medium">🎯 Perfect match for your preferences!</p></div>' : ''}
                        ${isRecommended && !isTopMatch ? '<div class="mt-2"><p class="text-xs text-yellow-600 dark:text-yellow-400 font-medium">🤖 Recommended by AI</p></div>' : ''}
                        <div class="mt-3 pt-2 border-t border-gray-200 dark:border-gray-600">
                            <div class="flex items-center text-blue-500 dark:text-blue-400 text-xs">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                <span>Click to view on map</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Also filter Recommendations tab if search is active
            if (searchTerm.trim() && (recommendedStores.length > 0 || topMatchStore)) {
                const aiRecommendedStores = [];
                
                // Add top match first if it matches search and exists
                if (topMatchStore) {
                    const topStore = toyStores.find(s => s.id === topMatchStore);
                    if (topStore && (topStore.name.toLowerCase().includes(searchTerm) || topStore.specialties.some(spec => spec.toLowerCase().includes(searchTerm)))) {
                        aiRecommendedStores.push({ store: topStore, isTopMatch: true, isRecommended: false });
                    }
                }
                
                // Add recommended stores that match search
                recommendedStores.forEach(storeId => {
                    if (storeId !== topMatchStore) {
                        const store = toyStores.find(s => s.id === storeId);
                        if (store && (store.name.toLowerCase().includes(searchTerm) || store.specialties.some(spec => spec.toLowerCase().includes(searchTerm)))) {
                            aiRecommendedStores.push({ store, isTopMatch: false, isRecommended: true });
                        }
                    }
                });
                
                // Update Recommendations list with filtered results
                const aiRecommendationsList = document.getElementById('aiRecommendationsList');
                if (aiRecommendedStores.length > 0) {
                    aiRecommendationsList.innerHTML = aiRecommendedStores.map(({ store, isTopMatch, isRecommended }) => 
                        renderRecommendationCard(store, isTopMatch, isRecommended)
                    ).join('');
                } else {
                    aiRecommendationsList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-search text-3xl text-gray-400 dark:text-gray-500 mb-3"></i>
                            <p class="text-gray-600 dark:text-gray-400">No Recommendations match "${searchTerm}"</p>
                        </div>
                    `;
                }
            }
        });

        // Get Current Location Button functionality
        function getCurrentLocation() {
            const locationBtn = document.getElementById('getCurrentLocationBtn');
            const originalText = locationBtn.innerHTML;
            
            // Check if we're on HTTPS or localhost
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            
            if (!isSecure) {
                showLocationFixDialog();
                return;
            }
            
            // Show loading state
            locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Finding...';
            locationBtn.disabled = true;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const newLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Update user location
                        userLocation = newLocation;
                        
                        // Center map on new location
                        if (map) {
                            map.setCenter(newLocation);
                            map.setZoom(13);
                        }
                        
                        // Remove existing user location marker if it exists
                        if (userLocationMarker) {
                            userLocationMarker.setMap(null);
                        }
                        
                        // Add new user location marker
                        if (map) {
                            userLocationMarker = new google.maps.Marker({
                                position: newLocation,
                                map: map,
                                title: 'Your Current Location',
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: '#4285F4',
                                    fillOpacity: 1,
                                    strokeColor: '#ffffff',
                                    strokeWeight: 2
                                },
                                animation: google.maps.Animation.DROP
                            });
                        }

                        // Clear existing stores and markers
                        storeMarkers.forEach(({ marker }) => {
                            marker.setMap(null);
                        });
                        toyStores = [];
                        storeMarkers = [];
                        
                        // Reset Recommendations when location changes
                        recommendedStores = [];
                        topMatchStore = null;
                        
                        // Search for toy stores near new location
                        searchToyStores(newLocation);
                        
                        // Reset button
                        locationBtn.innerHTML = originalText;
                        locationBtn.disabled = false;
                        
                        // Show success message
                        showAlert('Location updated! Finding toy stores near you...');
                    },
                    (error) => {
                        console.log('Geolocation error details:', error);
                        
                        // Reset button first
                        locationBtn.innerHTML = originalText;
                        locationBtn.disabled = false;
                        
                        // Handle specific geolocation errors
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                showPermissionFixDialog();
                                break;
                            case error.POSITION_UNAVAILABLE:
                                showLocationUnavailableDialog();
                                break;
                            case error.TIMEOUT:
                                showTimeoutDialog();
                                break;
                            default:
                                showGenericLocationDialog();
                                break;
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000, // Increased timeout
                        maximumAge: 300000 // 5 minutes cache
                    }
                );
            } else {
                locationBtn.innerHTML = originalText;
                locationBtn.disabled = false;
                showLocationFixDialog();
            }
        }

        // Specific error dialog functions
        function showLocationFixDialog() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3">HTTPS Required</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Location services require a secure connection. Please:</p>
                        <div class="text-left bg-gray-50 dark:bg-gray-700 p-3 rounded mb-4">
                            <p class="text-sm"><strong>Quick Fix:</strong></p>
                            <p class="text-sm">1. Deploy to <strong>Netlify</strong> or <strong>GitHub Pages</strong></p>
                            <p class="text-sm">2. Or use <strong>localhost</strong> for testing</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="showManualLocationDialog()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">Enter Location Manually</button>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition-colors">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showPermissionFixDialog() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="text-center">
                        <i class="fas fa-location-arrow text-red-500 text-3xl mb-4"></i>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3">Location Access Denied</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">To enable location access:</p>
                        <div class="text-left bg-gray-50 dark:bg-gray-700 p-3 rounded mb-4 text-sm">
                            <p><strong>Chrome/Edge:</strong> Click 🔒 in address bar → Location → Allow</p>
                            <p><strong>Firefox:</strong> Click 🛡️ → Clear permissions</p>
                            <p><strong>Safari:</strong> Settings → Privacy → Location Services</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="window.location.reload()" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition-colors">Refresh & Try Again</button>
                            <button onclick="showManualLocationDialog()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">Enter Location Manually</button>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition-colors">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showLocationUnavailableDialog() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="text-center">
                        <i class="fas fa-satellite-dish text-orange-500 text-3xl mb-4"></i>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3">Location Unavailable</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">GPS signal not found. Try:</p>
                        <div class="text-left bg-gray-50 dark:bg-gray-700 p-3 rounded mb-4 text-sm">
                            <p>• Move outdoors or near a window</p>
                            <p>• Check if location services are enabled</p>
                            <p>• Try again in a few moments</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="getCurrentLocation(); this.closest('.fixed').remove()" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition-colors">Try Again</button>
                            <button onclick="showManualLocationDialog()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">Enter Location Manually</button>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition-colors">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showTimeoutDialog() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="text-center">
                        <i class="fas fa-clock text-yellow-500 text-3xl mb-4"></i>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3">Location Timeout</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Location request took too long. This can happen with poor GPS signal.</p>
                        <div class="flex flex-col gap-2">
                            <button onclick="getCurrentLocation(); this.closest('.fixed').remove()" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition-colors">Try Again</button>
                            <button onclick="showManualLocationDialog()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">Enter Location Manually</button>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition-colors">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showGenericLocationDialog() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="text-center">
                        <i class="fas fa-question-circle text-gray-500 text-3xl mb-4"></i>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3">Location Error</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Something went wrong with location detection.</p>
                        <div class="flex flex-col gap-2">
                            <button onclick="showManualLocationDialog()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">Enter Location Manually</button>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition-colors">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showManualLocationDialog() {
            // Close any existing modals
            document.querySelectorAll('.fixed').forEach(modal => {
                if (modal.classList.contains('bg-black')) modal.remove();
            });
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="text-center">
                        <i class="fas fa-map-pin text-blue-500 text-3xl mb-4"></i>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3">Enter Your Location</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Enter a city or address to find nearby toy stores:</p>
                        <input type="text" id="manualLocationInput" placeholder="e.g., San Francisco, CA" 
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white mb-4">
                        <div class="flex flex-col gap-2">
                            <button onclick="searchManualLocation()" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition-colors">Search Stores</button>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="usePresetLocation('New York, NY')" class="bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-sm hover:bg-gray-200 dark:hover:bg-gray-500 transition-colors">NYC</button>
                                <button onclick="usePresetLocation('Los Angeles, CA')" class="bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-sm hover:bg-gray-200 dark:hover:bg-gray-500 transition-colors">LA</button>
                                <button onclick="usePresetLocation('Chicago, IL')" class="bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-sm hover:bg-gray-200 dark:hover:bg-gray-500 transition-colors">Chicago</button>
                                <button onclick="usePresetLocation('Houston, TX')" class="bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-sm hover:bg-gray-200 dark:hover:bg-gray-500 transition-colors">Houston</button>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition-colors">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus on input
            setTimeout(() => {
                document.getElementById('manualLocationInput').focus();
            }, 100);
            
            // Handle enter key
            document.getElementById('manualLocationInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchManualLocation();
                }
            });
        }

        function usePresetLocation(locationName) {
            document.getElementById('manualLocationInput').value = locationName;
            searchManualLocation();
        }

        function searchManualLocation() {
            const locationInput = document.getElementById('manualLocationInput');
            const location = locationInput.value.trim();
            
            if (!location) {
                showAlert('Please enter a location');
                return;
            }
            
            // STEP 1: Aggressive UI protection before ANY location changes
            console.log('🛡️ STEP 1: Pre-location UI protection');
            ensureUIElementsVisibleEnhanced();
            
            // Use Google Geocoding to convert address to coordinates
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: location }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const newLocation = {
                        lat: results[0].geometry.location.lat(),
                        lng: results[0].geometry.location.lng()
                    };
                    
                    // Update location and search for stores
                    userLocation = newLocation;
                    
                    if (map) {
                        map.setCenter(newLocation);
                        map.setZoom(13);
                        
                        // Remove existing user location marker
                        if (userLocationMarker) {
                            userLocationMarker.setMap(null);
                        }
                        
                        // Add new location marker
                        userLocationMarker = new google.maps.Marker({
                            position: newLocation,
                            map: map,
                            title: 'Your Location: ' + location,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            },
                            animation: google.maps.Animation.DROP
                        });
                    }
                    
                    // Clear existing stores
                    storeMarkers.forEach(({ marker }) => {
                        marker.setMap(null);
                    });
                    toyStores = [];
                    storeMarkers = [];
                    
                    // Reset Recommendations when location changes
                    recommendedStores = [];
                    topMatchStore = null;
                    
                    // STEP 2: UI protection after map update
                    console.log('🛡️ STEP 2: Post-map-update UI protection');
                    ensureUIElementsVisibleEnhanced();
                    
                    // Ensure UI elements remain visible after location update
                    setTimeout(() => {
                        console.log('🛡️ STEP 3: Pre-store-search UI protection');
                        ensureUIElementsVisibleEnhanced();
                    }, 100);
                    
                    // Search for toy stores
                    searchToyStores(newLocation);
                    
                    // Close modal properly by finding the specific modal
                    const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
                    if (modal) {
                        modal.remove();
                    }
                    
                    // STEP 4: Final aggressive UI protection
                    setTimeout(() => {
                        console.log('🛡️ STEP 4: Final UI protection check');
                        ensureUIElementsVisibleEnhanced();
                    }, 500);
                    
                    // STEP 5: Continuous monitoring for first 10 seconds
                    const monitoringInterval = setInterval(() => {
                        console.log('🛡️ MONITORING: Continuous UI protection');
                        ensureUIElementsVisibleEnhanced();
                    }, 1000);
                    
                    // Stop monitoring after 10 seconds
                    setTimeout(() => {
                        clearInterval(monitoringInterval);
                        console.log('🛡️ MONITORING: UI protection monitoring stopped');
                    }, 10000);
                    
                    showAlert(`Location set to ${results[0].formatted_address}. Finding toy stores...`);
                } else {
                    showAlert('Location not found. Please try a different address or city.');
                }
            });
        }

        // Simple User Profile System
        let currentUser = {
            username: 'ToyCollector123',
            avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=40&h=40&fit=crop&crop=face',
            preferences: {
                favoriteTypes: ['action-figures', 'vintage', 'lego'],
                budget: 'moderate',
                ageRange: '6-10'
            },
            location: null
        };

        // Profile button functionality
        document.getElementById('profileBtn').addEventListener('click', () => {
            showUserProfileDialog();
        });

        function showUserProfileDialog() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="text-center">
                        <img src="${currentUser.avatar}" alt="Profile" class="w-20 h-20 rounded-full mx-auto mb-4">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3">User Profile</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Username</label>
                                <input type="text" id="profileUsername" value="${currentUser.username}" 
                                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Avatar URL</label>
                                <input type="url" id="profileAvatar" value="${currentUser.avatar}" 
                                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Favorite Toy Types</label>
                                <input type="text" id="profileTypes" value="${currentUser.preferences.favoriteTypes.join(', ')}" 
                                       placeholder="action-figures, vintage, lego"
                                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Budget</label>
                                    <select id="profileBudget" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="low" ${currentUser.preferences.budget === 'low' ? 'selected' : ''}>Low ($10-50)</option>
                                        <option value="moderate" ${currentUser.preferences.budget === 'moderate' ? 'selected' : ''}>Moderate ($50-200)</option>
                                        <option value="high" ${currentUser.preferences.budget === 'high' ? 'selected' : ''}>High ($200+)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Age Range</label>
                                    <input type="text" id="profileAge" value="${currentUser.preferences.ageRange}" 
                                           placeholder="6-10"
                                           class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
                            <button onclick="saveUserProfile()" class="flex-1 px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded-lg transition-colors">Save Profile</button>
                        </div>
                        
                        <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                            <p class="text-xs text-blue-600 dark:text-blue-300">
                                <i class="fas fa-info-circle mr-1"></i>
                                Note: This profile is stored locally in your browser. Poe user account integration is not available.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveUserProfile() {
            // Get values from form
            const username = document.getElementById('profileUsername').value.trim();
            const avatar = document.getElementById('profileAvatar').value.trim();
            const types = document.getElementById('profileTypes').value.split(',').map(t => t.trim());
            const budget = document.getElementById('profileBudget').value;
            const ageRange = document.getElementById('profileAge').value.trim();

            if (!username) {
                showAlert('Please enter a username');
                return;
            }

            // Update current user
            currentUser.username = username;
            currentUser.avatar = avatar || currentUser.avatar;
            currentUser.preferences.favoriteTypes = types.filter(t => t);
            currentUser.preferences.budget = budget;
            currentUser.preferences.ageRange = ageRange;

            // Update UI (with null checks)
            const userNameElement = document.getElementById('userName');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (userNameElement) {
                userNameElement.textContent = username;
            }
            if (userAvatarElement) {
                userAvatarElement.src = currentUser.avatar;
            }

            // Save to localStorage (since we can't use sessionStorage)
            try {
                const userData = JSON.stringify(currentUser);
                // Create a simple storage mechanism using URL parameters or other methods
                // For demo purposes, we'll just update the display
                console.log('User profile saved:', currentUser);
            } catch (error) {
                console.log('Storage not available, using in-memory only');
            }

            // Close modal
            document.querySelector('.fixed').remove();
            
            showAlert('Profile updated successfully!');
        }

        // Load user profile on app start
        function loadUserProfile() {
            // In a real app, you'd load from your backend or storage
            // For demo, we'll use the default profile
            const userNameElement = document.getElementById('userName');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (userNameElement) {
                userNameElement.textContent = currentUser.username;
            }
            if (userAvatarElement) {
                userAvatarElement.src = currentUser.avatar;
            }
        }

        // Generate user ID for posts
        function generateUserId() {
            return currentUser.username || 'Anonymous';
        }

        // Focus store on map when clicked from list (Updated for overlay UI)
        function focusStoreOnMap(storeId) {
            // Find the store data
            const store = toyStores.find(s => s.id === storeId);
            if (!store || !map) {
                console.log('Store not found or map not ready');
                return;
            }

            // Find the corresponding marker
            const storeMarker = storeMarkers.find(sm => sm.store.id === storeId);
            if (!storeMarker) {
                console.log('Marker not found for store:', storeId);
                return;
            }

            // Close store panel when clicking on a store (with proper overlay handling)
            closeStorePanel();

            // Center map on store location with smooth animation
            map.panTo(new google.maps.LatLng(store.location.lat, store.location.lng));

  
            // Zoom in to get a closer view of the store
            if (map.getZoom() < 18) {
                map.setZoom(18);
            }

	    // Highlight the marker temporarily
            const originalIcon = storeMarker.marker.getIcon();
            
            // Create pulsing effect
            //storeMarker.marker.setIcon({
            //    path: google.maps.SymbolPath.CIRCLE,
            //    scale: 15,
            //    fillColor: '#3B82F6', // Blue color for focus
            //    fillOpacity: 0.8,
            //    strokeColor: '#ffffff',
            //    strokeWeight: 3
            //});

            // Add bounce animation
            storeMarker.marker.setAnimation(google.maps.Animation.BOUNCE);

            // Show info window after a short delay
            setTimeout(() => {
                showStoreInfo(store, storeMarker.marker);
                
                // Stop animation after showing info
                storeMarker.marker.setAnimation(null);
		
		// Restore original icon after 3 seconds
                setTimeout(() => {
                    storeMarker.marker.setIcon(originalIcon);
                }, 3000); 
            }, 500);

            // For mobile devices, provide haptic feedback if available
            if ('vibrate' in navigator) {
                navigator.vibrate(50); // Short vibration
            }

            // Show a toast notification for better UX
            showLocationToast(store.name);
        }

        // Show a temporary toast notification when focusing on a store
        function showLocationToast(storeName) {
            // Remove any existing toast
            const existingToast = document.querySelector('.location-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'location-toast fixed top-20 left-1/2 transform -translate-x-1/2 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-map-marker-alt"></i>
                    <span class="text-sm font-medium">Showing ${storeName} on map</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translate(-50%, 0)';
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 2500);
        }

        // Force render stores when empty despite having data
        function forceRenderStores() {
            console.log('Force rendering stores...');
            const nearbyContent = document.getElementById('nearbyTabContent');
            
            if (toyStores.length === 0) {
                nearbyContent.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-store text-3xl text-gray-400 dark:text-gray-500 mb-3"></i>
                        <p class="text-gray-600 dark:text-gray-400">No toy stores found</p>
                        <p class="text-sm text-gray-500 dark:text-gray-500">Try a different location or check back later</p>
                    </div>
                `;
                return;
            }
            
            // Force regenerate the store list HTML
            nearbyContent.innerHTML = toyStores.map(store => {
                const isRecommended = recommendedStores.includes(store.id);
                const isTopMatch = topMatchStore === store.id;
                
                let badgeHtml = '';
                if (isTopMatch) {
                    badgeHtml = '<div class="flex items-center mb-2"><span class="text-xs bg-green-500 text-white px-2 py-1 rounded-full flex items-center"><i class="fas fa-crown mr-1"></i>Top Match</span></div>';
                } else if (isRecommended) {
                    badgeHtml = '<div class="flex items-center mb-2"><span class="text-xs bg-yellow-400 text-gray-900 px-2 py-1 rounded-full flex items-center"><i class="fas fa-robot mr-1"></i>Recommended</span></div>';
                }
                
                return `
                    <div onclick="focusStoreOnMap('${store.id}')" class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md hover:scale-105 transition-all cursor-pointer ${isRecommended ? 'ring-2 ring-yellow-200 dark:ring-yellow-600' : ''} ${isTopMatch ? 'ring-2 ring-green-200 dark:ring-green-600' : ''}">
                        ${badgeHtml}
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-900 dark:text-white">${store.name}</h4>
                            <div class="flex items-center text-yellow-500">
                                <i class="fas fa-star mr-1"></i>
                                <span class="text-sm">${store.rating}</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${store.address}</p>
                        <p class="text-sm text-primary font-medium mb-2">${store.distance} away</p>
                        <div class="flex flex-wrap gap-1 mb-2">
                            ${store.specialties.map(spec => `
                                <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded">${spec}</span>
                            `).join('')}
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${store.hours}</p>
                        ${isTopMatch ? '<div class="mt-2"><p class="text-xs text-green-600 dark:text-green-400 font-medium">🎯 Perfect match for your preferences!</p></div>' : ''}
                        ${isRecommended && !isTopMatch ? '<div class="mt-2"><p class="text-xs text-yellow-600 dark:text-yellow-400 font-medium">🤖 Recommended by AI</p></div>' : ''}
                        <div class="mt-3 pt-2 border-t border-gray-200 dark:border-gray-600">
                            <div class="flex items-center text-blue-500 dark:text-blue-400 text-xs">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                <span>Click to view on map</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('Force render complete, stores now showing:', nearbyContent.innerHTML.length > 0);
        }

        // Function to ensure critical UI elements remain visible
        function ensureUIElementsVisible() {
            // Get header and search elements
            const header = document.querySelector('header');
            const searchOverlay = document.querySelector('.fixed.top-16');
            const mapLegend = document.querySelector('.mobile-landscape-legend-adaptive');
            
            // Restore header visibility and styles
            if (header) {
                header.style.display = 'block';
                header.style.visibility = 'visible';
                header.style.opacity = '1';
                header.style.position = 'fixed';
                header.style.top = '0';
                header.style.left = '0';
                header.style.right = '0';
                header.style.zIndex = '50';
                header.classList.remove('hidden');
                console.log('Header visibility restored');
            }
            
            // Restore search overlay visibility and styles
            if (searchOverlay) {
                searchOverlay.style.display = 'block';
                searchOverlay.style.visibility = 'visible';
                searchOverlay.style.opacity = '1';
                searchOverlay.style.position = 'fixed';
                searchOverlay.style.zIndex = '30';
                searchOverlay.classList.remove('hidden');
                console.log('Search overlay visibility restored');
            }
            
            // Restore map legend visibility
            if (mapLegend) {
                mapLegend.style.display = 'block';
                mapLegend.style.visibility = 'visible';
                mapLegend.style.opacity = '1';
                mapLegend.classList.remove('hidden');
                console.log('Map legend visibility restored');
            }
            
            // Force re-check of dark mode to ensure proper styling
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // Diagnostic function to check UI element status
        function checkUIElementsStatus() {
            const header = document.querySelector('header');
            const searchOverlay = document.querySelector('.fixed.top-16');
            const mapLegend = document.querySelector('.mobile-landscape-legend-adaptive');
            
            console.log('=== UI Elements Status Check ===');
            console.log('Header:', {
                exists: !!header,
                display: header?.style.display || 'default',
                visibility: header?.style.visibility || 'default',
                opacity: header?.style.opacity || 'default',
                zIndex: header?.style.zIndex || 'default',
                classes: header?.className || 'none'
            });
            
            console.log('Search Overlay:', {
                exists: !!searchOverlay,
                display: searchOverlay?.style.display || 'default',
                visibility: searchOverlay?.style.visibility || 'default', 
                opacity: searchOverlay?.style.opacity || 'default',
                zIndex: searchOverlay?.style.zIndex || 'default',
                classes: searchOverlay?.className || 'none'
            });
            
            console.log('Map Legend:', {
                exists: !!mapLegend,
                display: mapLegend?.style.display || 'default',
                visibility: mapLegend?.style.visibility || 'default',
                opacity: mapLegend?.style.opacity || 'default',
                classes: mapLegend?.className || 'none'
            });
            
            // Check for conflicting elements
            const allFixedElements = document.querySelectorAll('.fixed');
            console.log('All fixed elements count:', allFixedElements.length);
            allFixedElements.forEach((el, index) => {
                const rect = el.getBoundingClientRect();
                console.log(`Fixed element ${index}:`, {
                    tag: el.tagName,
                    zIndex: window.getComputedStyle(el).zIndex,
                    position: `${rect.top}, ${rect.left}`,
                    size: `${rect.width}x${rect.height}`,
                    classes: el.className.slice(0, 50) + '...'
                });
            });
        }

        // Enhanced ensureUIElementsVisible with more aggressive restoration
        function ensureUIElementsVisibleEnhanced() {
            console.log('🔧 Running enhanced UI protection...');
            
            // Check if DOM is ready
            if (document.readyState === 'loading') {
                console.warn('⚠️ DOM still loading, deferring UI protection...');
                document.addEventListener('DOMContentLoaded', ensureUIElementsVisibleEnhanced);
                return;
            }
            
            // Debug: Check all elements in DOM
            console.log('🔍 DOM Debug - All elements:');
            console.log('- Total elements:', document.querySelectorAll('*').length);
            console.log('- Header tags:', document.querySelectorAll('header').length);
            console.log('- Fixed elements:', document.querySelectorAll('.fixed').length);
            console.log('- Body children:', document.body.children.length);
            
            // Get elements with detailed debugging
            const header = document.querySelector('header');
            const mapLegend = document.querySelector('.mobile-landscape-legend-adaptive');
            const collectionsBtn = document.getElementById('collectionsToggleBtn');
            const profileBtn = document.getElementById('profileBtn');
            const searchInput = document.getElementById('searchInput');
            
            // Additional selectors to try if main ones fail
            const headerAlt = document.getElementsByTagName('header')[0];
            const legendAlt = document.querySelector('[class*="legend"]');
            
            console.log('🔍 Element search results:');
            console.log('- header (querySelector):', !!header);
            console.log('- header (getElementsByTagName):', !!headerAlt);
            console.log('- mapLegend:', !!mapLegend);
            console.log('- legendAlt:', !!legendAlt);
            console.log('- collectionsBtn:', !!collectionsBtn);
            console.log('- profileBtn:', !!profileBtn);
            console.log('- searchInput:', !!searchInput);
            
            // Check status before
            checkUIElementsStatus();
            
            // Restore header with maximum priority
            if (header) {
                // Remove any conflicting classes
                header.classList.remove('hidden', 'invisible', 'opacity-0');
                
                // Force styles with !important equivalent
                header.style.setProperty('display', 'block', 'important');
                header.style.setProperty('visibility', 'visible', 'important');
                header.style.setProperty('opacity', '1', 'important');
                header.style.setProperty('position', 'fixed', 'important');
                header.style.setProperty('top', '0', 'important');
                header.style.setProperty('left', '0', 'important');
                header.style.setProperty('right', '0', 'important');
                header.style.setProperty('z-index', '50', 'important');
                header.style.setProperty('pointer-events', 'auto', 'important');
                
                console.log('✅ Header restored with priority styles');
            } else {
                console.error('❌ Header element not found!');
            }
            
            // Ensure search input functionality (now part of header)
            if (searchInput) {
                searchInput.style.setProperty('pointer-events', 'auto', 'important');
                searchInput.disabled = false;
                console.log('✅ Search input functionality restored');
            }
            
            // Restore map legend
            if (mapLegend) {
                mapLegend.classList.remove('hidden', 'invisible', 'opacity-0');
                mapLegend.style.setProperty('display', 'block', 'important');
                mapLegend.style.setProperty('visibility', 'visible', 'important');
                mapLegend.style.setProperty('opacity', '1', 'important');
                
                console.log('✅ Map legend restored');
            }
            
            // CRITICAL: Ensure collections and profile buttons remain functional
            if (collectionsBtn) {
                collectionsBtn.style.setProperty('pointer-events', 'auto', 'important');
                collectionsBtn.style.setProperty('z-index', '55', 'important'); // Higher than header
                collectionsBtn.disabled = false;
                console.log('✅ Collections button functionality restored');
            }
            
            if (profileBtn) {
                profileBtn.style.setProperty('pointer-events', 'auto', 'important');
                profileBtn.style.setProperty('z-index', '55', 'important'); // Higher than header
                profileBtn.disabled = false;
                console.log('✅ Profile button functionality restored');
            }
            
            // Check for and remove any full-screen overlays that might be covering UI
            const suspiciousOverlays = document.querySelectorAll('.fixed.inset-0');
            suspiciousOverlays.forEach((overlay, index) => {
                const computedStyle = window.getComputedStyle(overlay);
                const zIndex = parseInt(computedStyle.zIndex) || 0;
                
                if (zIndex > 50 && !overlay.id.includes('modal') && !overlay.id.includes('loading') && !overlay.id.includes('collectionsOverlay')) {
                    console.warn(`🚨 Found suspicious overlay with z-index ${zIndex}:`, overlay);
                    // Optionally lower its z-index or hide it
                    overlay.style.setProperty('z-index', '25', 'important');
                }
            });
            
            // Final status check
            setTimeout(() => {
                console.log('🔍 Post-restoration status:');
                checkUIElementsStatus();
            }, 100);
        }

        // Make functions globally available
        window.focusStoreOnMap = focusStoreOnMap;
        window.forceRenderStores = forceRenderStores;
        window.ensureUIElementsVisible = ensureUIElementsVisible;
        window.ensureUIElementsVisibleEnhanced = ensureUIElementsVisibleEnhanced;
        window.checkUIElementsStatus = checkUIElementsStatus;
        window.showManualLocationDialog = showManualLocationDialog;
        window.usePresetLocation = usePresetLocation;
        window.searchManualLocation = searchManualLocation;
        window.saveUserProfile = saveUserProfile;

        // Add event listener for location button
        document.getElementById('getCurrentLocationBtn').addEventListener('click', getCurrentLocation);

        // Initialize the app
        loadUserProfile();
        renderCollectionFeed();

        // Make initMap globally available for Google Maps callback
        window.initMap = initMap;
    </script>


</body></html>